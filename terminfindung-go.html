<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width'>
        <title>Terminfindung StugA GO</title>
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@500&family=Kanit&display=swap');
            * {
                font-family: 'Kanit', sans-serif;
            }

            body {
                max-width: 20cm;
                margin: auto;
                background-color: #212121;
                color: #e0e0e0;
                padding-left: 16px;
                padding-right: 16px;
            }

            option {
                font-family: 'IBM Plex Sans', sans-serif;
                font-weight: 500;
            }

            .error-text {
                color: #ff4a4a;
            }

            .success-text {
                color: #58ff58;
            }

            .img-centered {
                margin-left: auto;
                margin-right: auto;
                display: block;
            }

            .qr-background {
                background-color: #e0e0e0;
                padding: 16px;
                width: fit-content;
                margin: auto;
            }
        </style>
        <script type="text/javascript">
            const CACHE_KEY = "stuga-go-zeitslots-ersttreffen";

            var timeslots = [
                "08:00", "08:15", "08:30", "08:45",
                "09:00", "09:15", "09:30", "09:45",
                "10:00", "10:15", "10:30", "10:45",
                "11:00", "11:15", "11:30", "11:45",
                "12:00", "12:15", "12:30", "12:45",
                "13:00", "13:15", "13:30", "13:45",
                "14:00", "14:15", "14:30", "14:45",
                "15:00", "15:15", "15:30", "15:45",
                "16:00", "16:15", "16:30", "16:45",
                "17:00", "17:15", "17:30", "17:45",
                "18:00", "18:15", "18:30", "18:45",
                "19:00", "19:15", "19:30", "19:45"
            ];

            var days = [
                "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"
            ];

            var qrcode;

            window.onload = function() {
                qrcode = new QRCode(document.getElementById("qrcode"), {
                    width: 256,
                    height: 256,
                    colorDark: "#212121",
                    colorLight: "#e0e0e0",
                    correctLevel: QRCode.CorrectLevel.L
                });
                restoreDataFromCache();
            }

            function restoreDataFromCache() {
                var stored = localStorage[CACHE_KEY];
                if (stored) {
                    var cachedData = JSON.parse(stored);

                    for (var entry of cachedData) {
                        addTimeslot(entry);
                    }
                }
            }

            function addTimeslot(data) {
                var container = document.getElementById("timeslots");
                var timeslot = document.getElementsByClassName("timeslot")[0];

                var newTimeslot = timeslot.cloneNode(true);
                container.appendChild(newTimeslot);
                
                if (data != null) {
                    newTimeslot.getElementsByClassName("day")[0].value = data.d;
                    newTimeslot.getElementsByClassName("time-start")[0].value = data.s;
                    newTimeslot.getElementsByClassName("time-end")[0].value = data.e;
                }
            }

            function generateQrCode() {
                try {
                    var flippedTimeslots = 0;
                    var removedIdenticalTimeslots = 0;

                    var entries = [];

                    clearErrors();
                    var timeslotChildren = document.getElementById("timeslots").children;
                    
                    if (timeslotChildren.length == 0) {
                        throwNothingError();
                        return;
                    }

                    for (var timeslot of timeslotChildren) {
                        var day = timeslot.getElementsByClassName("day")[0].selectedOptions[0].value;
                        var start = timeslot.getElementsByClassName("time-start")[0].selectedOptions[0].value;
                        var end = timeslot.getElementsByClassName("time-end")[0].selectedOptions[0].value;

                        if (day == "" || start == "" || end == "") {
                            throwUnfinishedError();
                            return;
                        }

                        if (start > end) {
                            // flip
                            var temp = start;
                            start = end;
                            end = temp;

                            timeslot.getElementsByClassName("time-start")[0].value = start;
                            timeslot.getElementsByClassName("time-end")[0].value = end;
                            
                            flippedTimeslots += 1;
                        
                        } else if (start == end) {
                            // identical -> remove

                            timeslot.remove();

                            removedIdenticalTimeslots += 1;
                            continue;
                        }

                        entries.push({d: day, s: start, e: end});
                    }

                    var stringifiedData = JSON.stringify(entries);
                    localStorage[CACHE_KEY] = stringifiedData;

                    if (entries.length > 0) {
                        displayQrCode(stringifiedData);
                        showSuccess(flippedTimeslots, removedIdenticalTimeslots);
                    } else {
                        showEntriesRemoved(removedIdenticalTimeslots);
                    }

                } catch (error) {
                    document.getElementById("unexpected").style.display = "block";
                    document.getElementById("stacktrace").innerText = error;
                }
            }

            function displayQrCode(data) {
                qrcode.clear();
                qrcode.makeCode(data);
                document.getElementById("qrcode-container").style.display = "block";
            }

            function showEntriesRemoved(removedIdenticalTimeslots) {
                document.getElementById("removed").style.display = "block";
                var n = "";
                var plural = "Eintrag";
                if (removedIdenticalTimeslots != 1) {
                    n = "n";
                    plural = "Eintr√§ge";
                }
                document.getElementById("removed-message-appendix").innerText = `${removedIdenticalTimeslots} ${plural} wurde${n} entfernt, da die Start- und Endzeiten gleich waren. Daher konnte kein QR-Code generiert werden.`;
            }

            function showSuccess(flippedTimeslots, removedIdenticalTimeslots) {
                var flippedTimeslotsPlural = "";
                if (flippedTimeslots != 1) {
                    flippedTimeslotsPlural = "s";
                }
                var removedIdenticalTimeslotsPlural = "";
                if (removedIdenticalTimeslots != 1) {
                    removedIdenticalTimeslotsPlural = "s";
                }
                document.getElementById("success").style.display = "block";
                document.getElementById("success-message-appendix").innerText = `${flippedTimeslots} Zeitslot${flippedTimeslotsPlural} umgedreht und ${removedIdenticalTimeslots} Slot${removedIdenticalTimeslotsPlural} mit identischen Start- und Endzeiten entfernt.`;
            }

            function hideSuccess() {
                document.getElementById("success").style.display = "none";
            }

            function clearErrors() {
                document.getElementById("unfinished").style.display = "none";
                document.getElementById("nothing").style.display = "none";
                document.getElementById("removed").style.display = "none";
                document.getElementById("success").style.display = "none";
                document.getElementById("unexpected").style.display = "none";
            }

            function throwNothingError() {
                document.getElementById("nothing").style.display = "block";
            }

            function throwUnfinishedError() {
                document.getElementById("unfinished").style.display = "block";
            }
        </script>
    </head>
    <body>
        <div id="hidden" style="display: none;"> 
            <div class="timeslot" style="margin-top: 12px;">
                <select class="day" name="day">
                    <option value="">- w√§hle einen Tag -</option>
                    <option value="0">Montag</option>
                    <option value="1">Dienstag</option>
                    <option value="2">Mittwoch</option>
                    <option value="3">Donnerstag</option>
                    <option value="4">Freitag</option>
                    <option value="5">Samstag</option>
                    <option value="6">Sonntag</option>
                </select>
                <select class="time-start" name="time-start">
                    <option value="">- w√§hle eine Startuhrzeit -</option>
                    <option value="0800">08:00</option>
                    <option value="0815">08:15</option>
                    <option value="0830">08:30</option>
                    <option value="0845">08:45</option>
                    <option value="0900">09:00</option>
                    <option value="0915">09:15</option>
                    <option value="0930">09:30</option>
                    <option value="0945">09:45</option>
                    <option value="1000">10:00</option>
                    <option value="1015">10:15</option>
                    <option value="1030">10:30</option>
                    <option value="1045">10:45</option>
                    <option value="1100">11:00</option>
                    <option value="1115">11:15</option>
                    <option value="1130">11:30</option>
                    <option value="1145">11:45</option>
                    <option value="1200">12:00</option>
                    <option value="1215">12:15</option>
                    <option value="1230">12:30</option>
                    <option value="1245">12:45</option>
                    <option value="1300">13:00</option>
                    <option value="1315">13:15</option>
                    <option value="1330">13:30</option>
                    <option value="1345">13:45</option>
                    <option value="1400">14:00</option>
                    <option value="1415">14:15</option>
                    <option value="1430">14:30</option>
                    <option value="1445">14:45</option>
                    <option value="1500">15:00</option>
                    <option value="1515">15:15</option>
                    <option value="1530">15:30</option>
                    <option value="1545">15:45</option>
                    <option value="1600">16:00</option>
                    <option value="1615">16:15</option>
                    <option value="1630">16:30</option>
                    <option value="1645">16:45</option>
                    <option value="1700">17:00</option>
                    <option value="1715">17:15</option>
                    <option value="1730">17:30</option>
                    <option value="1745">17:45</option>
                    <option value="1800">18:00</option>
                    <option value="1815">18:15</option>
                    <option value="1830">18:30</option>
                    <option value="1845">18:45</option>
                    <option value="1900">19:00</option>
                    <option value="1915">19:15</option>
                    <option value="1930">19:30</option>
                    <option value="1945">19:45</option>
                    <option value="2000">20:00</option>
                </select>
                <select class="time-end" name="time-end">
                    <option value="">- w√§hle eine Enduhrzeit -</option>
                    <option value="0800">08:00</option>
                    <option value="0815">08:15</option>
                    <option value="0830">08:30</option>
                    <option value="0845">08:45</option>
                    <option value="0900">09:00</option>
                    <option value="0915">09:15</option>
                    <option value="0930">09:30</option>
                    <option value="0945">09:45</option>
                    <option value="1000">10:00</option>
                    <option value="1015">10:15</option>
                    <option value="1030">10:30</option>
                    <option value="1045">10:45</option>
                    <option value="1100">11:00</option>
                    <option value="1115">11:15</option>
                    <option value="1130">11:30</option>
                    <option value="1145">11:45</option>
                    <option value="1200">12:00</option>
                    <option value="1215">12:15</option>
                    <option value="1230">12:30</option>
                    <option value="1245">12:45</option>
                    <option value="1300">13:00</option>
                    <option value="1315">13:15</option>
                    <option value="1330">13:30</option>
                    <option value="1345">13:45</option>
                    <option value="1400">14:00</option>
                    <option value="1415">14:15</option>
                    <option value="1430">14:30</option>
                    <option value="1445">14:45</option>
                    <option value="1500">15:00</option>
                    <option value="1515">15:15</option>
                    <option value="1530">15:30</option>
                    <option value="1545">15:45</option>
                    <option value="1600">16:00</option>
                    <option value="1615">16:15</option>
                    <option value="1630">16:30</option>
                    <option value="1645">16:45</option>
                    <option value="1700">17:00</option>
                    <option value="1715">17:15</option>
                    <option value="1730">17:30</option>
                    <option value="1745">17:45</option>
                    <option value="1800">18:00</option>
                    <option value="1815">18:15</option>
                    <option value="1830">18:30</option>
                    <option value="1845">18:45</option>
                    <option value="1900">19:00</option>
                    <option value="1915">19:15</option>
                    <option value="1930">19:30</option>
                    <option value="1945">19:45</option>
                    <option value="2000">20:00</option>
                </select>
                <button onclick="return this.parentNode.remove();" class="remove">‚ùå</button>
            </div>
        </div>
        <h1>Terminfindung f√ºr das StugA GO-Ersttreffen</h1>
        <img class="img-centered" src="/resources/misc/willywave.gif" alt="Willy from the Simpsons waving at you" style="height: 200px; width: 200px;">
        <p>
            Hey ihr Lieben!<br><br>Wir wollen uns mal mit so vielen Leuten aus unserer Gruppe wie m√∂glich treffen bevor wir uns endg√ºltig gr√ºnden, um uns mal besser kennenzulernen, paar Sachen zu besprechen, und all sowas :) Damit wir einen geeigneten Termin f√ºr unser Ersttreffen finden k√∂nnen, trag hier bitte deine Kann-Zeiten ein, klick den Knopf "Speichern & QR-Code generieren" unten, und schick einen Screenshot des QR-Codes bitte an mich (Deniz)!<br><br>P.S.: die Daten bleiben auf deinem Ger√§t gespeichert, also wenn du ein paar Zeitslots erstellst, auf Speichern klickst, und dann sp√§ter weitere Slots hinzuf√ºgen m√∂chtest, brauchst du die bereits bestehenden Slots nicht erneut einzutragen ‚Äì aber bitte schick mir den aktualisierten QR-Code im Nachhinein!<br><br>Vielen Dank! ~Deniz üåø
        </p>
        <h2>Deine Kann-Zeiten</h2>
        <button onclick="addTimeslot()">+ Neuen Zeitslot hinzuf√ºgen</button>
        <div id="timeslots"></div>
        <button onclick="generateQrCode()" style="margin-top: 16px;">Speichern & QR-Code generieren</button>
        <div id="unfinished" style="display: none;">
            <p class="error-text">Da stimmt was nicht!</p>
            <p>Achte drauf, dass in jedem Feld etwas eingetragen ist ‚Äì Tag, Startuhrzeit, und Enduhrzeit!</p>
        </div>
        <div id="nothing" style="display: none;">
            <p class="error-text">Da fehlt was!</p>
            <p>Keine Zeiten eingetragen, kein QR-Code!</p>
        </div>
        <div id="removed" style="display: none;">
            <p class="error-text">Alles weg!</p>
            <p id="removed-message-appendix"></p>
        </div>
        <div id="unexpected" style="display: none;">
            <p class="error-text">Das h√§tte nicht passieren sollen!</p>
            <p>Etwas ist schief gelaufen, und es ist wahrscheinlich nicht deine Schuld! Schick mir das mal bitte ‚Äì thaanks :)</p>
            <p id="stacktrace"></p>
        </div>
        <div id="success" style="display: none;">
            <p class="success-text">QR-Code erfolgreich erstellt!</p>
            <p id="success-message-appendix"></p>
        </div>
        <div id="qrcode-container" class="div-centered qr-background" style="margin-top: 24px; display: none;">
            <div id="qrcode"></div>
        </div>
        <div style="margin-bottom: 128px;"></div>
    </body>
</html>