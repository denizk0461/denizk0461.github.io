<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width'>
        <title>Terminscanner StugA GO</title>
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@500&family=Kanit&display=swap');
            * {
                font-family: 'Kanit', sans-serif;
            }

            body {
                max-width: 20cm;
                margin: auto;
                background-color: #212121;
                color: #e0e0e0;
                padding-left: 16px;
                padding-right: 16px;
            }

            option {
                font-family: 'IBM Plex Sans', sans-serif;
                font-weight: 500;
            }

            .error-text {
                color: #ff4a4a;
            }

            .success-text {
                color: #58ff58;
            }

            .img-centered {
                margin-left: auto;
                margin-right: auto;
                display: block;
            }

            .qr-background {
                background-color: #e0e0e0;
                padding: 16px;
                width: fit-content;
                margin: auto;
            }

            video {
                width: 80%;
                height: 80%;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js" integrity="sha512-a/IwksuXdv0Q60tVkQpwMk5qY+6cJ0FJgi33lrrIddoFItTRiRfSdU1qogP3uYjgHfrGY7+AC+4LU4J+b9HcgQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script type="text/javascript" src="//unpkg.com/linq-es2015/dist/linq.min.js"></script>
        <script>
            const CACHE_KEY = "stuga-go-zeitslots-ersttreffen";
            var qrscanner;
            var people = [
                "Amelie",
                "Dana A",
                "Dana B",
                "Deniz",
                "Jan",
                "Ranya",
                "Rina",
                "Saskia",
                "Thilo"
            ];
            var dataset = [
                [], [], [], [], [], [], [], [], []
            ];

            var id = 0;

            var possibleTimeslotTemplate = {
                availablePeopleCount: -1,
                day: -1,
                timeStart: -1,
                timeEnd: -1,
                availablePeople: []
            };

            var calculatedTimeslots = [];

            var timeslots = [
                "08:00", "08:15", "08:30", "08:45",
                "09:00", "09:15", "09:30", "09:45",
                "10:00", "10:15", "10:30", "10:45",
                "11:00", "11:15", "11:30", "11:45",
                "12:00", "12:15", "12:30", "12:45",
                "13:00", "13:15", "13:30", "13:45",
                "14:00", "14:15", "14:30", "14:45",
                "15:00", "15:15", "15:30", "15:45",
                "16:00", "16:15", "16:30", "16:45",
                "17:00", "17:15", "17:30", "17:45",
                "18:00", "18:15", "18:30", "18:45",
                "19:00", "19:15", "19:30", "19:45"
            ];

            var days = [
                "Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"
            ];

            window.onload = function() {
                qrscanner = new QrScanner(
                    document.getElementById("qrscanner"),
                    result => scanSuccess(result), {
                        returnDetailedScanResult: true
                    },
                );
                // findCommonTimeslots();
                mockData();
            }

            function mockData() {
                data = [{"d":"0","s":"1000","e":"1400"},{"d":"2","s":"1000","e":"1200"},{"d":"2","s":"1600","e":"2000"},{"d":"3","s":"0800","e":"1630"},{"d":"4","s":"1000","e":"1400"}];
                var data2 = [{"d":"0","s":"1000","e":"1400"},{"d":"2","s":"1000","e":"1200"},{"d":"2","s":"1600","e":"2000"}];
                dataset[8] = data;
                dataset[6] = data;
                dataset[1] = data2;

                findCommonTimeslots();
            }

            function scanSuccess(result) {
                addToDataset(result.data);
                qrscanner.stop();
            }

            function startScan() {
                document.getElementById("noperson").style.display = "none";
                qrscanner.start();
            }

            function addToDataset(data) {
                var selectedPerson = document.getElementsByClassName("person")[0].selectedOptions[0].value;
                if (selectedPerson == "") {
                    document.getElementById("noperson").style.display = "block";
                    return;
                }

                // console.log(data);
                dataset[selectedPerson] = JSON.parse(data);
                // console.log(dataset);

                var peopleScanned = "";
                var peopleScannedCount = 0;
                for (var i = 0; i < dataset.length; i += 1) {
                    if (dataset[i].length != 0) {
                        if (peopleScanned != "") {
                            peopleScanned += ", "
                        }
                        peopleScanned += people[i];
                        peopleScannedCount += 1;
                    }
                }
                document.getElementById("peoplescanned").innerText = "QR-Codes fÃ¼r folgende Personen wurden gescannt: " + peopleScanned;

                // console.log(JSON.parse(data));

                if (peopleScannedCount > 1) {
                    findCommonTimeslots();
                }
            }

            var timeslotStarts = [
                "0800", "0815", "0830", "0845", 
                "0900", "0915", "0930", "0945", 
                "1000", "1015", "1030", "1045", 
                "1100", "1115", "1130", "1145", 
                "1200", "1215", "1230", "1245", 
                "1300", "1315", "1330", "1345", 
                "1400", "1415", "1430", "1445", 
                "1500", "1515", "1530", "1545", 
                "1600", "1615", "1630", "1645", 
                "1700", "1715", "1730", "1745", 
                "1800", "1815", "1830", "1845", 
                "1900", "1915", "1930", "1945"
            ]

            var timeslotEnds = [
                "0815", "0830", "0845", "0900", 
                "0915", "0930", "0945", "1000", 
                "1015", "1030", "1045", "1100", 
                "1115", "1130", "1145", "1200", 
                "1215", "1230", "1245", "1300", 
                "1315", "1330", "1345", "1400", 
                "1415", "1430", "1445", "1500", 
                "1515", "1530", "1545", "1600", 
                "1615", "1630", "1645", "1700", 
                "1715", "1730", "1745", "1800", 
                "1815", "1830", "1845", "1900", 
                "1915", "1930", "1945", "2000"
            ]

            function findCommonTimeslots() {
                calculatedTimeslots = [];

                var baseArray = [].concat.apply([], dataset);

                var finalArray = [];
                for (var i = 0; i < dataset.length; i += 1) {
                    for (var j = 0; j < dataset[i].length; j += 1) {
                        var newElement = JSON.parse(JSON.stringify(dataset[i][j]));
                        newElement.p = i;
                        finalArray.push(newElement);
                    }
                }

                // console.log("--- FINAL ARRAY ---")
                // console.log(finalArray);

                // up to this point confirmed works

                var listOfTimeslots = [];

                // TODO this needs to wrap around from 60 -> 0 (not count up from 0 to 100)
                for (var a = 0; a < finalArray.length; a += 1) {//var element of finalArray) {
                    // var iterationsNeeded = (parseInt(element.e) - parseInt(element.s)) / 15;
                    var element = JSON.parse(JSON.stringify(finalArray[a]));
                    // console.log(element);
                    var iterationsNeeded = getIterationsNeeded(element.s, element.e);
                    // console.log(iterationsNeeded);
                    var start = parseInt(element.s);
                    var end = addWithWrapAround(start);
                    for (var i = 0; i < iterationsNeeded; i += 1) {
                        element = JSON.parse(JSON.stringify(element));
                        // console.log(`A: ${start}, ${end}`);
                        // console.log(parseInt(element.s));
                        element.s = start;
                        // end = addWithWrapAround(start);
                        element.e = end;
                        listOfTimeslots.push(element);
                        // console.log(element);
                        start = end;
                        end = addWithWrapAround(end);
                    }
                }

                // console.log(listOfTimeslots);
                // WORKS

                // console.log("--- SPLIT TIMESLOTS ---")
                // console.log(listOfTimeslots);

                // i think it works up to here too

                // console.log(listOfTimeslots
                //     .GroupBy(ts => ts.s, ts => ts.e));

                for (var d = 0; d < 7; d += 1) {
                    for (var i = 0; i < timeslotStarts.length; i += 1) {

                        var currentTimeslots = listOfTimeslots.filter(function(e) {
                            return e.s == timeslotStarts[i] && e.d == d;
                        });

                        var ts = {
                            availablePeopleCount: currentTimeslots.length,
                            day: d,
                            timeStart: timeslotStarts[i],
                            timeEnd: timeslotEnds[i],
                            availablePeople: currentTimeslots.map(p => p.p)
                        };

                        calculatedTimeslots.push(ts);
                    }
                }

                calculatedTimeslots = calculatedTimeslots.filter(c => c.availablePeopleCount > 0);

                console.log(calculatedTimeslots);

                // possibleTimeslotTemplate

                // TODO combine timeslots back into largest segments possible

                // console.log("--- COMMON TIME SLOTS ---")
                // console.log(calculatedTimeslots);

                // console.log(
                //     Enumerable.asEnumerable(finalArray)
                //         .SelectMany(a => Count(a.p), a.s, a.e)
                //         .GroupBy(a => a.s, a.e)
                // );
            }
            
            function getIterationsNeeded(start, end) {
                var counter = 0;
                start = parseInt(start);
                end = parseInt(end);
                while (start < end) {
                    counter += 1;
                    start = addWithWrapAround(start);
                }
                return counter;
            }

            function pad(num, size) {
                num = num.toString();
                while (num.length < size) num = "0" + num;
                return num;
            }

            function addWithWrapAround(num) {
                if (parseInt(num.toString().substring(num.toString().length - 2)) == 45) {
                    return parseInt(num) + 55;
                } else {
                    return parseInt(num) + 15;
                }
            }
        </script>
    </head>
    <body>
        <h1>Terminscanner fÃ¼r das StugA GO-Ersttreffen</h1>
        <button onclick="startScan()">Scan starten</button>
        <select class="person" name="person">
            <option value="">- wÃ¤hle eine Person -</option>
            <option value="0">Amelie</option>
            <option value="1">Dana A</option>
            <option value="2">Dana B</option>
            <option value="3">Deniz</option>
            <option value="4">Jan</option>
            <option value="5">Ranya</option>
            <option value="6">Rina</option>
            <option value="7">Saskia</option>
            <option value="8">Thilo</option>
        </select>
        <video id="qrscanner"></video>
        <div id="noperson" style="display: none;">
            <p class="error-text">Keine Person ausgewÃ¤hlt!</p>
        </div>
        <p id="peoplescanned"></p>
    </body>
</html>